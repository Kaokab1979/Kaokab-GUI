#!/usr/bin/env bash
set -euo pipefail

# ============================================================
# KAOKABCTL â€” KAOKAB5GC Operations Controller
# Purpose:
#   - Single control/inspection point for GUI & CLI
#   - Emits structured JSON (machine-consumable)
#
# Design:
#   - Each block is isolated (NFs, RAN, Subscribers)
#   - Easy to extend without breaking existing logic
# ============================================================


# ------------------------------------------------------------
# CONFIGURATION
# ------------------------------------------------------------

NFS=(
  mongod
  open5gs-nrfd
  open5gs-scpd
  open5gs-amfd
  open5gs-smfd
  open5gs-upfd
  open5gs-udrd
  open5gs-udmd
  open5gs-ausfd
  open5gs-pcfd
  open5gs-nssfd
  open5gs-bsfd
  open5gs-seppd
  open5gs-mmed
  open5gs-hssd
  open5gs-sgwcd
  open5gs-sgwud
  open5gs-pcrfd
)
# ------------------------------------------------------------
# STATE STORAGE (persistent)
# ------------------------------------------------------------

STATE_DIR="/var/lib/kaokab"
RAN_STATE_FILE="${STATE_DIR}/ran.json"

mkdir -p "$STATE_DIR"
[[ -f "$RAN_STATE_FILE" ]] || echo '{}' > "$RAN_STATE_FILE"


# ------------------------------------------------------------
# UTILITY FUNCTIONS
# ------------------------------------------------------------

json_escape() {
  sed 's/"/\\"/g'
}


# ------------------------------------------------------------
# BLOCK: NETWORK FUNCTIONS (systemd)
# ------------------------------------------------------------

emit_ran() {
  local now
  now="$(date -Is)"

  # Local IPv4 addresses (AMF side)
  local local_ips
  local_ips="$(ip -o -4 addr show | awk '{print $4}' | cut -d/ -f1)"

  # Detect remote gNB peers (NGAP 38412)
  local detected_ips
  detected_ips="$(
    ss -H -n -A sctp sport = :38412 2>/dev/null \
      | awk '{print $5}' \
      | cut -d: -f1 \
      | sed 's/%.*//' \
      | sort -u \
      | while read -r ip; do
          echo "$local_ips" | grep -qx "$ip" || echo "$ip"
        done
  )"

  # Load previous state
  local state
  state="$(cat "$RAN_STATE_FILE")"

  # Update last_seen timestamps
  for ip in $detected_ips; do
    state="$(jq --arg ip "$ip" --arg ts "$now" '.[$ip].last_seen = $ts' <<<"$state")"
  done

  # Persist state
  echo "$state" > "$RAN_STATE_FILE"

  # Emit JSON
  echo '  "ran": {'
  echo '    "gnb_ngap_38412":'

  jq -c '
    to_entries
    | map({ ip: .key, last_seen: .value.last_seen })
  ' <<<"$state" | sed 's/^/      /'

  echo '    , "enb_s1ap_36412": []'
  echo '  },'
}

# ------------------------------------------------------------
# BLOCK: SUBSCRIBERS
#   - Placeholder for MongoDB integration
# ------------------------------------------------------------

emit_subscribers() {
  echo '  "subscribers": []'
}


# ------------------------------------------------------------
# COMMAND: status
# ------------------------------------------------------------

cmd_status() {
  echo '{'
  echo '  "ts": "'"$(date -Is)"'",'

  emit_nfs
  emit_ran
  emit_subscribers

  echo '}'
}


# ------------------------------------------------------------
# ENTRYPOINT
# ------------------------------------------------------------

case "${1:-}" in
  status)
    cmd_status
    ;;
  *)
    echo "Usage: $0 status" >&2
    exit 2
    ;;
esac
